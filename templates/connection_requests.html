{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto mt-8">
    <h2 class="text-2xl font-bold mb-6">Connection Requests</h2>

    <!-- Requests I Received -->
    <h4 class="text-lg font-semibold mb-4">Requests for you</h4>
    {% if received_requests %}
        <ul class="space-y-4">
            {% for req in received_requests %}
                <li class="p-4 bg-gray-100 rounded-lg flex items-center justify-between">
                    <span class="font-medium">{{ req.sender.username }}</span>
                    <div class="flex space-x-2">
                        <!-- View Profile -->
                        <a href="{% url 'view_user_profile' req.sender.id %}" 
                           class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            View Profile
                        </a>

                        <!-- Accept -->
                        <form method="POST" action="{% url 'respond_connection_request' req.id 'accept' %}">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 transition-colors">
                                Accept
                            </button>
                        </form>

                        <!-- Reject with Modal -->
                        <button type="button" 
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors"
                                onclick="openRejectModal({{ req.id }}, '{{ req.sender.username }}')">
                            Reject
                        </button>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-600">No new requests üéâ</p>
    {% endif %}

    <!-- Divider -->
    <hr class="my-6">

    <!-- Friends List -->
    <h4 class="text-lg font-semibold mb-4">Friends</h4>
    {% if friends %}
        <ul class="space-y-2">
            {% for f in friends %}
                <li class="p-3 bg-green-100 rounded flex justify-between items-center">
                    {% if f.sender == user %}
                        <a href="{% url 'view_user_profile' f.receiver.id %}" 
                            class="text-indigo-700 font-semibold hover:underline">
                            {{ f.receiver.username }}
                        </a>
                    {% else %}
                        <a href="{% url 'view_user_profile' f.sender.id %}" 
                            class="text-indigo-700 font-semibold hover:underline">
                            {{ f.sender.username }}
                        </a>
                    {% endif %}

                    <span class="text-green-700">‚úÖ Friend</span>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-600">You have no friends yet.</p>
    {% endif %}

    <!-- Divider -->
    <hr class="my-6">

    <!-- Requests I Sent -->
    <h4 class="text-lg font-semibold mb-4">Requests you sent</h4>
    {% if sent_requests %}
        <ul class="space-y-2">
            {% for req in sent_requests %}
                <li class="p-3 bg-white rounded shadow">
                    To <span class="font-semibold">{{ req.receiver.username }}</span> ‚Üí
                    Status:
                    {% if req.status == "pending" %}
                        <span class="text-yellow-500">‚è≥ Pending</span>
                    {% elif req.status == "accepted" %}
                        <span class="text-green-600">‚úÖ Friends</span>
                    {% else %}
                        <span class="text-red-500">‚ùå Rejected</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-gray-600">You haven‚Äôt sent any requests yet.</p>
    {% endif %}
</div>

<!-- Reject Modal -->
<div id="rejectModal" class="fixed inset-0 hidden flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300 opacity-0">
    <div class="bg-white rounded-lg p-6 w-96 transform scale-95 transition-transform duration-300">
        <h3 class="text-lg font-semibold mb-4">Reject Connection</h3>
        <p class="mb-4">Are you sure you want to reject <span id="modalUsername" class="font-bold"></span>?</p>
        <div class="flex justify-end space-x-2">
            <button class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 transition-colors" onclick="closeRejectModal()">
                Cancel
            </button>
            <form id="rejectForm" method="POST">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                    Reject
                </button>
            </form>
        </div>
    </div>
</div>


<script>
    function openRejectModal(reqId, username) {
        const modal = document.getElementById('rejectModal');
        const form = document.getElementById('rejectForm');
        const usernameSpan = document.getElementById('modalUsername');

        form.action = `/api/connection/respond/${reqId}/reject/`;
        usernameSpan.textContent = username;

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.firstElementChild.classList.remove('scale-95');
        }, 10);
    }

    function closeRejectModal() {
        const modal = document.getElementById('rejectModal');
        modal.classList.add('opacity-0');
        modal.firstElementChild.classList.add('scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
</script>
{% endblock %}
